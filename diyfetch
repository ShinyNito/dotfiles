#!/bin/sh

#åˆ¤æ–­æ˜¯å¦å®‰è£…gum
if ! command -v gum &> /dev/null; then
    exit 1
fi

# Prepare ------------------------------------------------------------------------------------------


# è·å–æ“ä½œç³»ç»Ÿçš„å†…æ ¸åç§°
kernel=$(uname -s)
bodyWidth=30
# æ£€æŸ¥å†…æ ¸åç§°
if [ "$kernel" = "Linux" ]; then
  # å¦‚æœæ˜¯ Linux å†…æ ¸ï¼Œä½¿ç”¨ /etc/os-release æ–‡ä»¶æ¥è·å–æ“ä½œç³»ç»Ÿåç§°
  os_name=$(cat /etc/os-release | grep -oP '(?<=^NAME=")(.*)(?=")')
  cpu_name=$(cat /proc/cpuinfo | grep "model name" | awk -F: '{print $2}' | head -1 | sed 's/^[ \t]*//')
  # åˆ¤æ–­CPU_name çš„é•¿åº¦

  up_time=$(uptime -p | cut -c 4- | cut -d ',' -f -2)
elif [ "$kernel" = "Darwin" ]; then
  # å¦‚æœæ˜¯ Darwin å†…æ ¸ï¼Œä½¿ç”¨ sw_vers å‘½ä»¤æ¥è·å– macOS çš„äº§å“åç§°
  os_name=$(sw_vers -productName)
  cpu_name=$(sysctl -n machdep.cpu.brand_string)
  # å¦‚æœ30 - 38 < 0ï¼Œè¯´æ˜cpu_nameçš„é•¿åº¦å°äºbodyWidthï¼Œå¦åˆ™è¯´æ˜cpu_nameçš„é•¿åº¦å¤§äºbodyWidth
  up_time=$(uptime | awk '{print $3, $4, $5}' | tr -d ',')
else
  # å¦‚æœæ˜¯å…¶ä»–æ“ä½œç³»ç»Ÿï¼Œæ— æ³•ç¡®å®šæ“ä½œç³»ç»Ÿåç§°
  os_name="Unknown"
  cpu_name="Unknown"
fi

if [ $((bodyWidth - ${#cpu_name})) -lt 0 ]; then
    bodyWidth=$(( ${#cpu_name} + 10 ))
fi
echo $bodyWidth
exit 1

package_manager=$(which brew || which apt || which yum || which pacman || which dnf || which nix-env || which apk || which yumdnf)

main_color=4

title="  [38;5;${main_color}mï€‡ [0m: [1;38;5;${main_color}m${USER}[0m@[1;38;5;${main_color}m$(hostname)[0m"
body=$(gum style --border normal --border-foreground 7 --padding '0 1' --width ${bodyWidth} \
"[38;5;${main_color}mî™ [0m: ${os_name}
[38;5;${main_color}mó°› [0m: ${cpu_name}
[38;5;${main_color}mï’‰ [0m: $(basename "${SHELL}")
[38;5;${main_color}mî‚ [0m: $(date +"%Y-%m-%d %H:%M:%S")
[38;5;${main_color}mï¨™[0m: ${up_time}
[38;5;${main_color}mï…« [0m: $(basename "$package_manager")")
info=$(gum join --vertical "${title}" "${body}")

if [ "$kernel" = "Linux" ]; then

  # å¦‚æœæ˜¯ Darwin å†…æ ¸ï¼Œä½¿ç”¨ sw_vers å‘½ä»¤æ¥è·å– macOS çš„äº§å“åç§°
  art=$(gum style '    [34m___[0m
   [34m([0m.. [34m|[0m
   [34m([33m<> [34m|[0m
  [34m/ [0m__  [34m\[0m
 [34m( [0m/  \[34m/ |[0m
[33m_[34m/\ [0m__)[34m/[33m_[34m)[0m
[33m\/[34m-____[33m\/[0m')
else
art=$(gum style "        [32m_[0m
       [32m(/[0m
  [32m.---__--.[0m
 [33m//////////[4m\[0m
[31m|//////////[0m
[31m|/////////\_[0m
 [35m\//////////[0m
  [34m\`.[4m/[0;34m\".[4m/[0;34m/\'[0m")

fi

color=$(gum style '[0;30mâ–ˆâ–ˆâ–ˆ[0;31mâ–ˆâ–ˆâ–ˆ[0;32mâ–ˆâ–ˆâ–ˆ[0;33mâ–ˆâ–ˆâ–ˆ[0;34mâ–ˆâ–ˆâ–ˆ[0;35mâ–ˆâ–ˆâ–ˆ[0;36mâ–ˆâ–ˆâ–ˆ[0;37mâ–ˆâ–ˆâ–ˆ[0m
[0;1;90mâ–ˆâ–ˆâ–ˆ[0;1;91mâ–ˆâ–ˆâ–ˆ[0;1;92mâ–ˆâ–ˆâ–ˆ[0;1;93mâ–ˆâ–ˆâ–ˆ[0;1;94mâ–ˆâ–ˆâ–ˆ[0;1;95mâ–ˆâ–ˆâ–ˆ[0;1;96mâ–ˆâ–ˆâ–ˆ[0;1;97mâ–ˆâ–ˆâ–ˆ[0m')


# Display ------------------------------------------------------------------------------------------

terminal_size=$(stty size)
terminal_height=${terminal_size% *}
terminal_width=${terminal_size#* }

prompt_height=${PROMPT_HEIGHT:-1}

print_test() {
	no_color=$(printf '%b' "${1}" | sed -e 's/\x1B\[[0-9;]*[JKmsu]//g')

  #if [ "$kernel" = "Linux" ]; then
    # å¦‚æœæ˜¯ Linux å†…æ ¸ï¼Œä½¿ç”¨ /etc/os-release æ–‡ä»¶æ¥è·å–æ“ä½œç³»ç»Ÿåç§°
  #  [ "$(printf '%s' "${no_color}" | wc --lines)" -gt $(( terminal_height - prompt_height )) ] && return 1
  #  [ "$(printf '%s' "${no_color}" | wc --max-line-length)" -gt "${terminal_width}" ] && return 1
  #else
   # å¦‚æœæ˜¯ Darwin å†…æ ¸ï¼Œä½¿ç”¨ sw_vers å‘½ä»¤æ¥è·å– macOS çš„äº§å“åç§°
  #  [ "$(printf '%s' "${no_color}" | wc -l)" -gt $(( terminal_height - prompt_height )) ] && return 1
  #  [ "$(printf '%s' "${no_color}" | awk '{ if (length > max) { max = length } } END { print max }')" -gt "${terminal_width}" ] && return 1
  #fi

	gum style --align left --width="${terminal_width}" "${1}" ''
	printf '%b' "\033[A"

	exit 0
}


# Default layout
echo ""
group_info_color=$(gum join --vertical --align center "${info}" "${color}")
print_test "$(gum join --horizontal --align left '  ' "${art}" '  ' "${group_info_color}")"

# Other layout
print_test "$(gum join --horizontal --align center '  ' "${art}" '  ' "${info}")"
print_test "${group_info_color}"
print_test "${info}"

exit 1